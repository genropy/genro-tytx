<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYTX Visual Schema Editor</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 45% 55%;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Editor Styles */
        .struct-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
            background: #fff;
            overflow: hidden;
        }

        .struct-header {
            background: #f1f5f9;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .struct-name-input {
            font-weight: bold;
            border: 1px solid transparent;
            background: transparent;
            font-size: 1rem;
            padding: 2px 5px;
        }

        .struct-name-input:hover,
        .struct-name-input:focus {
            border-color: var(--border);
            background: white;
        }

        .field-list {
            padding: 10px;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 100px 1fr 30px;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .field-input {
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-icon {
            cursor: pointer;
            color: #94a3b8;
            border: none;
            background: none;
            font-size: 1.1rem;
        }

        .btn-icon:hover {
            color: var(--danger);
        }

        .btn-add {
            background: #e0e7ff;
            color: var(--primary);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Preview Styles */
        fieldset {
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8fafc;
        }

        legend {
            font-weight: 600;
            color: var(--primary);
            padding: 0 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Code Output */
        #codeOutput {
            font-family: monospace;
            font-size: 0.85rem;
            color: #475569;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: auto;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>

    <!-- LEFT PANEL: VISUAL EDITOR -->
    <div class="panel">
        <h2>
            Schema Editor
            <div style="display:flex; gap:5px;">
                <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="loadFromFile()">
                <button onclick="document.getElementById('jsonFileInput').click()"
                    style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9rem;">üìÅ
                    Import JSON</button>
                <button onclick="exportToJSON()"
                    style="background:#f59e0b; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9rem;">üíæ
                    Export JSON</button>
                <button onclick="addStruct()"
                    style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9rem;">+
                    New Struct</button>
            </div>
        </h2>

        <div id="editorContainer"></div>

        <h3 style="margin-top: 20px; font-size:1rem; color:#64748b;">Generated TYTX Code</h3>
        <div id="codeOutput"></div>
    </div>

    <!-- RIGHT PANEL: FORM PREVIEW -->
    <div class="panel" style="background: #f0fdf4; border-color: #bbf7d0;">
        <h2>UI Preview</h2>
        <div style="margin-bottom: 15px;">
            <label>Preview Root: </label>
            <select id="rootSelector" onchange="renderPreview()" style="padding:5px;"></select>
        </div>
        <form id="formPreview" onsubmit="return false;"></form>
    </div>

    <script>
        // State
        let SCHEMA = [
            {
                name: 'INDIRIZZO',
                fields: [
                    { name: 'indirizzo', type: 'T', meta: 'max:60, lbl:Indirizzo' },
                    { name: 'cap', type: 'T', meta: 'len:5, lbl:CAP' },
                    { name: 'comune', type: 'T', meta: 'max:60, lbl:Comune' },
                    { name: 'provincia', type: 'T', meta: 'len:2, lbl:Prov' },
                    { name: 'nazione', type: 'T', meta: 'len:2, def:IT, lbl:Nazione' }
                ]
            },
            {
                name: 'ANAGRAFICA',
                fields: [
                    { name: 'denominazione', type: 'T', meta: 'max:80, lbl:Ragione Sociale' },
                    { name: 'nome', type: 'T', meta: 'max:60, lbl:Nome' },
                    { name: 'cognome', type: 'T', meta: 'max:60, lbl:Cognome' },
                    { name: 'piva', type: 'T', meta: 'max:30, lbl:Partita IVA' },
                    { name: 'cod_fiscale', type: 'T', meta: 'len:16, lbl:Codice Fiscale' }
                ]
            },
            {
                name: 'SOGGETTO',
                fields: [
                    { name: 'anagrafica', type: '@ANAGRAFICA', meta: 'lbl:Dati Anagrafici' },
                    { name: 'sede', type: '@INDIRIZZO', meta: 'lbl:Sede Legale' },
                    { name: 'regime_fisc', type: 'T', meta: 'len:4, lbl:Regime Fiscale' }
                ]
            },
            {
                name: 'RIGA',
                fields: [
                    { name: 'num', type: 'L', meta: 'lbl:N.' },
                    { name: 'desc', type: 'T', meta: 'max:1000, lbl:Descrizione' },
                    { name: 'qty', type: 'N', meta: 'dec:8, lbl:Quantit√†' },
                    { name: 'price', type: 'N', meta: 'dec:8, lbl:Prezzo Unitario' },
                    { name: 'sconto', type: 'N', meta: 'dec:2, lbl:Sconto %' },
                    { name: 'iva', type: 'N', meta: 'dec:2, lbl:Aliquota IVA' },
                    { name: 'natura', type: 'T', meta: 'len:2, lbl:Natura' }
                ]
            },
            {
                name: 'TESTATA',
                fields: [
                    { name: 'tipo_doc', type: 'T', meta: 'len:4, lbl:Tipo Documento' },
                    { name: 'divisa', type: 'T', meta: 'len:3, def:EUR, lbl:Valuta' },
                    { name: 'data', type: 'D', meta: 'lbl:Data Fattura' },
                    { name: 'numero', type: 'T', meta: 'max:20, lbl:Numero' },
                    { name: 'causale', type: '#T', meta: 'max:200, lbl:Causale' }
                ]
            },
            {
                name: 'RIEPILOGO',
                fields: [
                    { name: 'aliquota', type: 'N', meta: 'dec:2, lbl:Aliquota' },
                    { name: 'imponibile', type: 'N', meta: 'dec:2, lbl:Imponibile' },
                    { name: 'imposta', type: 'N', meta: 'dec:2, lbl:Imposta' },
                    { name: 'esigibilita', type: 'T', meta: 'len:1, lbl:Esigibilit√†' }
                ]
            },
            {
                name: 'FATTURA',
                fields: [
                    { name: 'trasmittente', type: '@SOGGETTO', meta: 'lbl:Trasmittente' },
                    { name: 'cedente', type: '@SOGGETTO', meta: 'lbl:Cedente / Prestatore' },
                    { name: 'cessionario', type: '@SOGGETTO', meta: 'lbl:Cessionario / Committente' },
                    { name: 'testata', type: '@TESTATA', meta: 'lbl:Dati Generali' },
                    { name: 'righe', type: '#@RIGA', meta: 'lbl:Dettaglio Linee' },
                    { name: 'riepiloghi', type: '#@RIEPILOGO', meta: 'lbl:Dati Riepilogo' },
                    { name: 'pagamento', type: 'JS', meta: 'lbl:Dati Pagamento' }
                ]
            }
        ];

        const BASE_TYPES = ['T', 'L', 'N', 'D', 'B', 'JS'];

        // --- EDITOR RENDERING ---

        function renderEditor() {
            const container = document.getElementById('editorContainer');
            container.innerHTML = '';

            SCHEMA.forEach((struct, sIdx) => {
                const card = document.createElement('div');
                card.className = 'struct-card';

                // Header
                card.innerHTML = `
                    <div class="struct-header">
                        <input type="text" class="struct-name-input" value="${struct.name}" onchange="updateStructName(${sIdx}, this.value)">
                        <button class="btn-icon" onclick="deleteStruct(${sIdx})">√ó</button>
                    </div>
                    <div class="field-list" id="fields-${sIdx}">
                        <!-- Fields go here -->
                    </div>
                    <div style="padding:0 10px 10px 10px;">
                        <button class="btn-add" onclick="addField(${sIdx})">+ Add Field</button>
                    </div>
                `;

                const fieldList = card.querySelector(`#fields-${sIdx}`);
                struct.fields.forEach((field, fIdx) => {
                    const row = document.createElement('div');
                    row.className = 'field-row';

                    // Type Options (Base + Structs)
                    let typeOptions = BASE_TYPES.map(t => `<option value="${t}" ${field.type === t ? 'selected' : ''}>${t}</option>`).join('');

                    // Add Struct References (@NAME and #@NAME)
                    SCHEMA.forEach(s => {
                        const ref = `@${s.name}`;
                        const listRef = `#@${s.name}`;
                        typeOptions += `<option value="${ref}" ${field.type === ref ? 'selected' : ''}>${ref}</option>`;
                        typeOptions += `<option value="${listRef}" ${field.type === listRef ? 'selected' : ''}>${listRef}</option>`;
                    });

                    row.innerHTML = `
                        <input type="text" class="field-input" placeholder="Field Name" value="${field.name}" onchange="updateField(${sIdx}, ${fIdx}, 'name', this.value)">
                        <select class="field-input" onchange="updateField(${sIdx}, ${fIdx}, 'type', this.value)">
                            ${typeOptions}
                        </select>
                        <input type="text" class="field-input" placeholder="Metadata (lbl:..., len:...)" value="${field.meta}" onchange="updateField(${sIdx}, ${fIdx}, 'meta', this.value)">
                        <button class="btn-icon" onclick="deleteField(${sIdx}, ${fIdx})">√ó</button>
                    `;
                    fieldList.appendChild(row);
                });

                container.appendChild(card);
            });

            updateCodeOutput();
            updateRootSelector();
            renderPreview();
        }

        // --- ACTIONS ---

        function addStruct() {
            SCHEMA.push({ name: 'NEW_STRUCT', fields: [] });
            renderEditor();
        }

        function deleteStruct(idx) {
            if (confirm('Delete struct?')) {
                SCHEMA.splice(idx, 1);
                renderEditor();
            }
        }

        function updateStructName(idx, val) {
            SCHEMA[idx].name = val;
            renderEditor(); // Re-render to update type selectors in other structs
        }

        function addField(sIdx) {
            SCHEMA[sIdx].fields.push({ name: 'new_field', type: 'T', meta: '' });
            renderEditor();
        }

        function deleteField(sIdx, fIdx) {
            SCHEMA[sIdx].fields.splice(fIdx, 1);
            renderEditor();
        }

        function updateField(sIdx, fIdx, key, val) {
            SCHEMA[sIdx].fields[fIdx][key] = val;
            if (key === 'type') renderEditor(); // Re-render if type changes (might affect dependencies?)
            else {
                updateCodeOutput();
                renderPreview();
            }
        }

        // --- CODE GENERATION ---

        function updateCodeOutput() {
            let code = '';
            SCHEMA.forEach(s => {
                code += `${s.name} {\n`;
                s.fields.forEach((f, i) => {
                    const metaPart = f.meta ? `[${f.meta}]` : '';
                    const comma = i < s.fields.length - 1 ? ',' : '';
                    code += `    ${f.name}: ${f.type}${metaPart}${comma}\n`;
                });
                code += `}\n\n`;
            });
            document.getElementById('codeOutput').textContent = code.trim();
        }

        // --- PREVIEW RENDERING ---

        /**
         * Parse metadata string to object
         * Handles: key:value, key:"quoted value", enum:A|B|C
         */
        function parseMetadata(metaStr) {
            if (!metaStr || !metaStr.trim()) return {};

            const meta = {};
            let i = 0;
            const text = metaStr.trim();

            while (i < text.length) {
                // Skip whitespace
                while (i < text.length && /\s/.test(text[i])) i++;
                if (i >= text.length) break;

                // Parse key
                let key = '';
                while (i < text.length && text[i] !== ':') {
                    key += text[i++];
                }
                key = key.trim();
                if (i >= text.length) break;
                i++; // skip ':'

                // Skip whitespace after colon
                while (i < text.length && /\s/.test(text[i])) i++;

                // Parse value
                let value = '';
                if (text[i] === '"') {
                    // Quoted value
                    i++; // skip opening quote
                    while (i < text.length && text[i] !== '"') {
                        if (text[i] === '\\\\' && i + 1 < text.length) {
                            // Handle escape sequences
                            i++;
                            value += text[i++];
                        } else {
                            value += text[i++];
                        }
                    }
                    if (i < text.length) i++; // skip closing quote
                } else {
                    // Unquoted value (until comma or end)
                    while (i < text.length && text[i] !== ',') {
                        value += text[i++];
                    }
                    value = value.trim();
                }

                meta[key] = value;

                // Skip comma
                if (i < text.length && text[i] === ',') i++;
            }

            return meta;
        }

        function updateRootSelector() {
            const sel = document.getElementById('rootSelector');
            const current = sel.value || 'FATTURA'; // Default to FATTURA
            sel.innerHTML = SCHEMA.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            if (current && SCHEMA.find(s => s.name === current)) sel.value = current;
        }

        function renderPreview() {
            const rootName = document.getElementById('rootSelector').value;
            const container = document.getElementById('formPreview');
            container.innerHTML = '';

            if (!rootName) return;

            const rootStruct = SCHEMA.find(s => s.name === rootName);
            if (rootStruct) {
                container.appendChild(renderStructDOM(rootStruct));
            }
        }

        function renderStructDOM(structDef) {
            const wrapper = document.createElement('div');

            structDef.fields.forEach(f => {
                // Parse Meta using new parser
                const meta = parseMetadata(f.meta);
                const label = meta.lbl || f.name;

                // Nested Struct (@NAME)
                if (f.type.startsWith('@')) {
                    const nestedName = f.type.substring(1);
                    const nestedDef = SCHEMA.find(s => s.name === nestedName);

                    const details = document.createElement('details');
                    details.open = true;
                    details.style.marginBottom = '10px';
                    details.style.marginLeft = '10px';
                    details.innerHTML = `<summary style="cursor:pointer; font-weight:600; color:var(--primary);">${label}</summary>`;

                    const content = document.createElement('div');
                    content.style.paddingLeft = '15px';
                    content.style.borderLeft = '1px solid #cbd5e1';

                    if (nestedDef) {
                        content.appendChild(renderStructDOM(nestedDef));
                    } else {
                        content.innerHTML = `<div style="color:red">Missing struct: ${nestedName}</div>`;
                    }

                    details.appendChild(content);
                    wrapper.appendChild(details);
                    return;
                }

                // Array of Structs (#@NAME)
                if (f.type.startsWith('#@')) {
                    const nestedName = f.type.substring(2);
                    const nestedDef = SCHEMA.find(s => s.name === nestedName);

                    const details = document.createElement('details');
                    details.open = true;
                    details.style.marginBottom = '10px';
                    details.style.marginLeft = '10px';
                    details.innerHTML = `<summary style="cursor:pointer; font-weight:600; color:var(--primary);">${label} (List)</summary>`;

                    // Demo items
                    for (let i = 0; i < 2; i++) {
                        const itemDetails = document.createElement('details');
                        itemDetails.style.marginBottom = '5px';
                        itemDetails.innerHTML = `<summary style="cursor:pointer; font-size:0.9em">Item ${i + 1}</summary>`;
                        const itemContent = document.createElement('div');
                        itemContent.style.paddingLeft = '10px';

                        if (nestedDef) {
                            itemContent.appendChild(renderStructDOM(nestedDef));
                        }
                        itemDetails.appendChild(itemContent);
                        details.appendChild(itemDetails);
                    }
                    wrapper.appendChild(details);
                    return;
                }

                // Standard Field
                const group = document.createElement('div');
                group.className = 'form-group';
                let inputHtml = `<input type="text" class="form-control" placeholder="${meta.ph || ''}">`;

                if (meta.enum) {
                    const opts = meta.enum.split('|').map(o => `<option>${o}</option>`).join('');
                    inputHtml = `<select class="form-control">${opts}</select>`;
                } else if (f.type === 'B') {
                    inputHtml = `<label><input type="checkbox"> ${label}</label>`;
                }

                if (f.type !== 'B') {
                    group.innerHTML = `<label class="form-label">${label}</label>${inputHtml}`;
                } else {
                    group.innerHTML = inputHtml;
                }

                wrapper.appendChild(group);
            });

            return wrapper;
        }

        // --- IMPORT/EXPORT ---

        function loadFromFile() {
            const input = document.getElementById('jsonFileInput');
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        SCHEMA = json;
                        renderEditor();
                        alert(`Loaded ${json.length} structs successfully!`);
                    } else {
                        alert('Invalid JSON format. Expected an array of structs.');
                    }
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
                // Reset input
                input.value = '';
            };
            reader.readAsText(file);
        }

        function exportToJSON() {
            const json = JSON.stringify(SCHEMA, null, 4);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tytx_schema.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Init
        renderEditor();
    </script>
</body>

</html>